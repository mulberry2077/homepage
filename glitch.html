<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SYSTEM FAILURE</title>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
      font-family: "Courier New", monospace;
      position: relative;
      color: #fff;
    }

    body::before {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-image:
        repeating-linear-gradient(0deg,
          transparent,
          transparent 2px,
          rgba(255, 0, 0, 0.03) 2px,
          rgba(255, 0, 0, 0.03) 4px),
        repeating-linear-gradient(90deg,
          transparent,
          transparent 2px,
          rgba(0, 255, 255, 0.03) 2px,
          rgba(0, 255, 255, 0.03) 4px);
      opacity: 0.3;
      z-index: 1;
      pointer-events: none;
      animation: noise 0.2s infinite;
    }

    body::after {
      content: "";
      position: fixed;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background: repeating-linear-gradient(0deg,
        rgba(0, 0, 0, 0.15),
        rgba(0, 0, 0, 0.15) 1px,
        transparent 1px,
        transparent 2px);
      z-index: 2;
      pointer-events: none;
    }

    @keyframes noise {
      0%, 100% { opacity: 0.3; transform: translate(0, 0); }
      10% { opacity: 0.4; transform: translate(-2px, 1px); }
      20% { opacity: 0.25; transform: translate(1px, -1px); }
      30% { opacity: 0.35; transform: translate(0, 0); }
      40% { opacity: 0.3; transform: translate(1px, 0); }
      50% { opacity: 0.4; transform: translate(-1px, 1px); }
      60% { opacity: 0.25; transform: translate(0, -1px); }
      70% { opacity: 0.35; transform: translate(0, 0); }
      80% { opacity: 0.3; transform: translate(1px, 1px); }
      90% { opacity: 0.4; transform: translate(-1px, 0); }
    }

    .glitch-page {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: rgba(0, 0, 0, 0.72);
      z-index: 10;
      text-align: center;
      padding: 20px;
    }

    .glitch-title {
      font-size: 5rem;
      color: red;
      font-weight: 700;
      text-shadow:
        0 0 20px red,
        2px 0 0 rgba(255, 0, 0, 0.7),
        -2px 0 0 rgba(0, 255, 255, 0.7);
      margin-bottom: 20px;
      animation: glitch-text-anim 0.3s infinite;
      position: relative;
      z-index: 20;
    }

    .glitch-instruction {
      font-size: 2.2rem;
      color: white;
      margin-bottom: 12px;
      text-shadow:
        0 0 10px rgba(255, 255, 255, 0.8),
        0 0 20px rgba(255, 255, 255, 0.5);
      position: relative;
      z-index: 20;
    }

    .glitch-hint {
      font-size: 1.1rem;
      color: #aaa;
      margin-top: 10px;
      text-shadow: 0 0 5px rgba(170, 170, 170, 0.5);
      position: relative;
      z-index: 20;
    }

    @keyframes glitch-text-anim {
      0% { transform: translate(0); }
      20% { transform: translate(-2px, 2px); }
      40% { transform: translate(-2px, -2px); }
      60% { transform: translate(2px, 2px); }
      80% { transform: translate(2px, -2px); }
      100% { transform: translate(0); }
    }

    .key-feedback {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 10rem;
      font-weight: 700;
      color: rgba(255, 255, 255, 0.7);
      text-shadow:
        0 0 10px rgba(255, 255, 255, 0.5),
        0 0 30px rgba(255, 0, 0, 0.4);
      z-index: 50;
      pointer-events: none;
      user-select: none;
      mix-blend-mode: screen;
    }

    /* スマホ向け：見える入力欄 */
    .wake-panel {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      z-index: 25;
    }

    .wake-label {
      font-size: 0.95rem;
      color: rgba(255,255,255,0.75);
      text-shadow: 0 0 6px rgba(255,255,255,0.18);
    }

    .wake-input {
      width: min(320px, 86vw);
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.25);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      outline: none;
      font-size: 16px; /* iOSズーム回避 */
      text-align: center;
    }

    .wake-input::placeholder {
      color: rgba(255,255,255,0.45);
    }

    @media (max-width: 768px) {
      .glitch-title { font-size: 3rem; }
      .glitch-instruction { font-size: 1.4rem; }
      .key-feedback { font-size: 6rem; }
    }
  </style>
</head>

<body>
  <div class="glitch-page">
    <div class="glitch-title">SYSTEM FAILURE</div>
    <div class="glitch-instruction">TYPE "WAKE" TO REBOOT</div>
    <div class="glitch-hint">PC: type anywhere / Mobile: tap input</div>

    <div class="wake-panel">
      <div class="wake-label">ここをタップして「wake」と入力</div>
      <input
        id="wake-visible"
        class="wake-input"
        type="text"
        inputmode="text"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
        placeholder="wake"
        aria-label="Type WAKE here"
      />
    </div>
  </div>

  <script>
    // Flash effect loop
    (function flashLoop() {
      if (Math.random() > 0.82) {
        const el = document.createElement("div");
        el.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
          background: ${Math.random() > 0.5 ? "white" : "red"};
          opacity: ${Math.random() * 0.3};
          z-index: 999; pointer-events: none; mix-blend-mode: exclusion;
        `;
        document.body.appendChild(el);
        setTimeout(() => el.remove(), 100);
      }
      setTimeout(flashLoop, 150);
    })();

    // ===== WAKE detection (PC + Mobile) =====
    let keyBuffer = "";
    let redirected = false;

    function showKeyFeedback(char) {
      const fb = document.createElement("div");
      fb.className = "key-feedback";
      fb.textContent = char;
      document.body.appendChild(fb);
      setTimeout(() => fb.remove(), 160);
    }

    function redirectToEnding() {
      if (redirected) return;
      redirected = true;

      const STATE_KEY = "bar_sanctuary_state";
      try {
        const s = JSON.parse(localStorage.getItem(STATE_KEY)) || {};
        s.phase = 2;
        localStorage.setItem(STATE_KEY, JSON.stringify(s));
      } catch (e) {}

      window.location.href = "ending.html";
    }

    // PC側：1文字ずつ積む（どこでも入力OK）
    function pushFromKey(char) {
      if (!char || redirected) return;
      const letters = String(char).replace(/[^a-zA-Z]/g, "").toUpperCase();
      if (!letters) return;

      for (const ch of letters) {
        keyBuffer += ch;
        if (keyBuffer.length > 16) keyBuffer = keyBuffer.slice(-16);
        showKeyFeedback(ch);
        if (keyBuffer.endsWith("WAKE")) {
          redirectToEnding();
          return;
        }
      }
    }

    // Mobile側：入力欄の「現在値」全体で判定（予測変換/まとめ入力に強い）
    function checkWholeValueAndRedirect(value) {
      if (redirected) return;
      const normalized = String(value).replace(/[^a-zA-Z]/g, "").toUpperCase();
      // 入力中に WAKE が現れた瞬間に遷移（末尾一致ではなく「含む」判定）
      if (normalized.includes("WAKE")) {
        redirectToEnding();
      }
    }

    // --- PC: どこでも type できる（フォーカス依存を避ける） ---
    window.addEventListener("keydown", (e) => {
      const k = e.key || "";
      if (k.length === 1) {
        pushFromKey(k);
      }
    }, true);

    // --- Mobile: 見える入力欄 ---
    const wakeVisible = document.getElementById("wake-visible");

    // 入力を消さない：まず判定、遷移しなければ必要に応じて整形（ここではそのまま保持でもOK）
    wakeVisible.addEventListener("input", (e) => {
      checkWholeValueAndRedirect(e.target.value);
      // 遷移していない場合だけ、長くなりすぎないよう軽く制限
      if (!redirected && e.target.value.length > 20) {
        e.target.value = e.target.value.slice(-20);
      }
    });

    // IME確定時も同様に判定
    wakeVisible.addEventListener("compositionend", (e) => {
      checkWholeValueAndRedirect(wakeVisible.value + (e.data || ""));
      if (!redirected && wakeVisible.value.length > 20) {
        wakeVisible.value = wakeVisible.value.slice(-20);
      }
    });

    // 「入力が終わったらすぐ」＝ユーザーが確定を押す場合も拾う（保険）
    wakeVisible.addEventListener("change", (e) => {
      checkWholeValueAndRedirect(e.target.value);
    });

    // スマホで「どこをタップしても入力欄にフォーカス」誘導（任意）
    document.addEventListener("pointerdown", (e) => {
      if (redirected) return;
      if (!e.target.closest("input, textarea, button, a")) {
        if (window.matchMedia("(max-width: 768px)").matches) {
          try { wakeVisible.focus({ preventScroll: true }); }
          catch { wakeVisible.focus(); }
        }
      }
    });
  </script>
</body>
</html>
